<html>
<script src='socket.io/socket.io.js'></script>
<canvas id ="gameCanvas" width = "800" height = "600"></canvas>
<script src="https://code.jquery.com/jquery-1.10.2.js"></script>
<script src='client.js'></script>
<script src='drawing.js'></script>
<script src='utils.js'></script>

<script type="text/javascript">

window.requestAnimFrame = (function(){
  return  window.requestAnimationFrame       ||
          window.webkitRequestAnimationFrame ||
          window.mozRequestAnimationFrame    ||
          function( callback ){
            window.setTimeout(callback, 1000 / 60);
          };
})();

var server = null,
skipAuth = true,
serverRunning = false,
serverShutdownReason = "Error",
canvas = document.getElementById('gameCanvas'),
myShip = null,
mousex,
mousey,

moveForward = false,
moveBackward = false,
turnLeft = false,
turnRight = false,
canvasContext;

function auth(name){
    try{server = clientConnect(name);} catch (e) {
        console.log("Could not connect to server");
    }
    if(server){
        serverRunning = true;
        init();
    }
}

function init(){
    canvasContext = canvas.getContext('2d');
    animloop();
    canvas.addEventListener("mousemove", calcMousePos, false);
    canvas.addEventListener("click", handleClick, false);
    window.addEventListener("keydown", keyDown, false);
    window.addEventListener("keyup", keyUp, false);
}

function animloop(){
    if(serverRunning){
        requestAnimFrame(animloop);
        gameLoop();
    } else {
        drawBackground();
        drawText("The server has shutdown: " + serverShutdownReason,10,50);
    }
}

function gameLoop(){
    drawBackground();
    drawAliveCounter();
    drawShips();
    drawBullets();
}

function calcMousePos(evt){
    evt.preventDefault();
    var rect = canvas.getBoundingClientRect(),
        root = document.documentElement;
    mouseX = evt.pageX - rect.left - root.scrollLeft;
    mouseY = evt.pageY - rect.top - root.scrollTop;
    server.emit('mousemove',{x:mouseX,y:mouseY});
}

function handleClick(evt){
    evt.preventDefault();
    server.emit("click",{x:mouseX,y:mouseY});
}

function keyDown(evt){
    switch(evt.keyCode) {
        case 65: {turnLeft = true; break;} //Left key
        case 37: {turnLeft = true; break;} //Left key
        case 87: {moveForward = true; break;} //Up key
        case 38: {moveForward = true; break;} //Up key
        case 68: {turnRight = true; break;}//Right key
        case 39: {turnRight = true; break;}//Right key
        case 83: {moveBackward = true; break;} //Down key
        case 40: {moveBackward = true; break;} //Down key
    }
    server.emit('movement',{turnLeft:turnLeft,moveForward:moveForward,turnRight:turnRight,moveBackward:moveBackward});
}

function keyUp(evt){
    switch(evt.keyCode) {
        case 65: {turnLeft = false; break;} //Left key
        case 37: {turnLeft = false; break;} //Left key
        case 87: {moveForward = false; break;} //Up key
        case 38: {moveForward = false; break;} //Up key
        case 68: {turnRight = false; break;}//Right key
        case 39: {turnRight = false; break;}//Right key
        case 83: {moveBackward = false; break;} //Down key
        case 40: {moveBackward = false; break;} //Down key
    }
    server.emit('movement',{turnLeft:turnLeft,moveForward:moveForward,turnRight:turnRight,moveBackward:moveBackward});
}

</script>

<script>
window.onload = function() {
    if(skipAuth){
       auth("Player" + getRandomInt(0,999999));
    } else{
        $('#authForm').show();
    }
}
</script>

<form id="authForm" hidden>
    Enter your username:<br>
    <input type="text" id="nameBox"></input>
    <input type="submit"></submit>
</form>

<script type="text/javascript">
$('#authForm').submit(function () {
 auth($('#nameBox').val());
 $('#authForm').hide();
 return false;
});
</script>

</html>