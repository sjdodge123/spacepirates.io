<html>
<script src='socket.io/socket.io.js'></script>
<div id="main">
    <div id="centerContainer">
        <div id="bannerBox">SpacePirates.io</div>
        <form id="authForm">
            <input type="text" id="nameBox"></input>
            <input type="submit" value="Play!"></input>
            <br>
            <input type="radio" name="color" value = "#ff00bf">Magenta</input>
            <input type="radio" name="color" value = "red">Red</input>
            <input type="radio" name="color" value = "green">Green</input>
            <input type="radio" name="color" value = "#66b3ff">Blue</input>
        </form>
    </div>
    <canvas id ="gameCanvas" width="800" height="600"></canvas>
</div>


<script src="https://code.jquery.com/jquery-1.10.2.js"></script>
<link rel="stylesheet" type="text/css" href="styles.css">
<script src='client.js'></script>
<script src='drawing.js'></script>
<script src='utils.js'></script>
<script type="text/javascript">

window.requestAnimFrame = (function(){
  return  window.requestAnimationFrame       ||
          window.webkitRequestAnimationFrame ||
          window.mozRequestAnimationFrame    ||
          function( callback ){
            window.setTimeout(callback, 1000 / 60);
          };
})();
var canvas = document.getElementById('gameCanvas');
var canvasContext = canvas.getContext('2d');
canvasContext.canvas.width  = window.innerWidth;
canvasContext.canvas.height = window.innerHeight;

var server = null,
skipAuth = false,
serverRunning = false,
iAmAlive = true,
timeOutChecker = null,
gameStarted = false,
victory = false,
serverShutdownReason = "Error",
shrinkTimeLeft = 60,
lobbyTimeLeft = 0,
toastTimer = null,
toastMessage = null,
totalPlayers = null,
myShip = null,
healthLastFrame = 100,
mousex,
mousey,

camera = {
    x : canvas.width/2,
    y : canvas.height/2,
    width : canvas.width,
    height : canvas.height,
    color : 'yellow',
    padding: -150,
    left: 0,
    right:0,
    top:0,
    bottom:0,
    xOffset: canvas.width/2,
    yOffset: canvas.height/2,

    centerOnObject : function(object){
       xOffset =  object.x - (canvas.width/2);
       yOffset =  object.y - (canvas.height/2);
    },

    draw : function() {
        canvasContext.beginPath();
        canvasContext.strokeStyle = this.color;
        canvasContext.rect(this.padding,this.padding,this.width-this.padding*2,this.height-this.padding*2);
        canvasContext.stroke();
    },

    inBounds: function(object){
        if(this.padding <= object.x - myShip.x  + this.xOffset &&
           this.width-this.padding >= object.x - myShip.x + this.xOffset &&
           this.padding <= object.y - myShip.y  + this.yOffset &&
           this.height-this.padding >= object.y - myShip.y + this.yOffset
           ){
           return true;
        }
        return false;
    },

    move : function(x,y){
        this.xOffset += x;
        this.yOffset += y;
    }  
},

moveForward = false,
moveBackward = false,
turnLeft = false,
turnRight = false,
canvasContext;

function auth(name,color){
    try{server = clientConnect({name:name,color:color});} catch (e) {
        console.log("Could not connect to server");
    }
    if(server){
        serverRunning = true;
        $('#centerContainer').hide();
        init();
    }
}

function init(){
    
    timeOutChecker = setInterval(checkForTimeout,1000);
    animloop();
    canvas.addEventListener("mousemove", calcMousePos, false);
    canvas.addEventListener("click", handleClick, false);
    window.addEventListener("keydown", keyDown, false);
    window.addEventListener("keyup", keyUp, false);
}

function animloop(){
    if(serverRunning){
        requestAnimFrame(animloop);
        gameLoop();
    } else {
        drawBackground();
        drawText("The server has shutdown: " + serverShutdownReason,10,50);
    }
}

function gameLoop(){
    if(myID == null || myShip == null){
        return;
    }
    drawBackground();
    drawRelativeObjects();
    drawHUD();
    if(iAmAlive){
        if(victory){
            gameOver();
            return;
        }
        checkForDamage();
    } else{
        drawDeathText();
    }
}

function gameOver(){
    drawVictoryScreen();
    server.emit('movement',{turnLeft:false,moveForward:false,turnRight:false,moveBackward:false});
    canvas.removeEventListener("mousemove", calcMousePos, false);
    canvas.removeEventListener("click", handleClick, false);
    window.removeEventListener("keydown", keyDown, false);
    window.removeEventListener("keyup", keyUp, false);
    server.disconnect();
}

function checkForDamage(){
    if(shipList[myID].health < healthLastFrame){
        drawFlashScreen();
    }
    healthLastFrame = shipList[myID].health;
}

function calcMousePos(evt){
    evt.preventDefault();
    var rect = canvas.getBoundingClientRect(),
        root = document.documentElement;
    mouseX = evt.pageX - rect.left - root.scrollLeft + myShip.x - camera.xOffset;
    mouseY = evt.pageY - rect.top - root.scrollTop + myShip.y - camera.yOffset;
    server.emit('mousemove',{x:mouseX,y:mouseY});
}

function handleClick(evt){
    evt.preventDefault();
    if(iAmAlive){
       server.emit("click",{x:mouseX,y:mouseY}); 
    }
}

function keyDown(evt){
    switch(evt.keyCode) {
        case 65: {turnLeft = true; break;} //Left key
        case 37: {turnLeft = true; break;} //Left key
        case 87: {moveForward = true; break;} //Up key
        case 38: {moveForward = true; break;} //Up key
        case 68: {turnRight = true; break;}//Right key
        case 39: {turnRight = true; break;}//Right key
        case 83: {moveBackward = true; break;} //Down key
        case 40: {moveBackward = true; break;} //Down key
    }
    server.emit('movement',{turnLeft:turnLeft,moveForward:moveForward,turnRight:turnRight,moveBackward:moveBackward});
}

function keyUp(evt){
    switch(evt.keyCode) {
        case 65: {turnLeft = false; break;} //Left key
        case 37: {turnLeft = false; break;} //Left key
        case 87: {moveForward = false; break;} //Up key
        case 38: {moveForward = false; break;} //Up key
        case 68: {turnRight = false; break;}//Right key
        case 39: {turnRight = false; break;}//Right key
        case 83: {moveBackward = false; break;} //Down key
        case 40: {moveBackward = false; break;} //Down key
    }
    server.emit('movement',{turnLeft:turnLeft,moveForward:moveForward,turnRight:turnRight,moveBackward:moveBackward});
}

</script>

<script>
window.onload = function() {
    $('#nameBox').attr("placeholder","Guest"+getRandomInt(0,999999));
}
</script>



<script type="text/javascript">
var array = $('input[name=color]');
array[getRandomInt(0,array.length)].checked = true;

$('#authForm').submit(function () {
 auth($('#nameBox').val(),$('input[name=color]:checked').val());
 $('#authForm').hide();
 return false;
});
</script>

</html>